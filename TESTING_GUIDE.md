# 多IP用戶獨立性測試指南

## 概述

本指南將幫助您測試和驗證多IP用戶獨立性功能是否正常工作。

## 測試環境準備

### 1. 啟動服務器

```bash
# 方法1: 使用啟動腳本
python start_server.py

# 方法2: 直接啟動
python app.py
```

### 2. 確認服務器運行

訪問 http://localhost:5000 確認服務器正常運行。

## 測試方法

### 方法1: 使用測試腳本

```bash
python test_multi_ip.py
```

測試腳本會自動：
- 模擬3個不同IP的用戶
- 同時發送查詢請求
- 驗證每個用戶的獨立性

### 方法2: 手動測試

#### 步驟1: 準備多個瀏覽器或設備
- 使用不同的瀏覽器
- 使用不同的設備
- 使用不同的網絡連接

#### 步驟2: 同時發送查詢
1. 在每個瀏覽器中打開 http://localhost:5000
2. 輸入相同的問題和時間區間
3. 同時點擊"查詢"按鈕
4. 觀察每個瀏覽器的處理過程

#### 步驟3: 驗證獨立性
- 每個瀏覽器應該顯示獨立的處理過程
- 一個瀏覽器的操作不應影響其他瀏覽器
- 每個瀏覽器都應該獲得完整的答案

### 方法3: 使用curl命令測試

```bash
# 終端1: 模擬IP 192.168.1.100
curl -H "X-Forwarded-For: 192.168.1.100" \
     "http://localhost:5000/api/query/stream?question=EMX-BTX-D&date_range=20200101-20201231"

# 終端2: 模擬IP 192.168.1.101  
curl -H "X-Forwarded-For: 192.168.1.101" \
     "http://localhost:5000/api/query/stream?question=EMX-BTX-D&date_range=20200101-20201231"
```

## 預期結果

### ✅ 正常工作的標誌

1. **獨立任務ID**: 每個IP應該獲得不同的任務ID
2. **獨立處理過程**: 每個IP的搜索、篩選、答案生成過程互不影響
3. **獨立結果**: 每個IP都能獲得完整的答案
4. **頁面刷新停止**: 刷新頁面只會停止該IP的任務，不影響其他IP

### ❌ 問題的標誌

1. **任務被中斷**: 一個IP的查詢被另一個IP的操作中斷
2. **共享任務ID**: 多個IP獲得相同的任務ID
3. **處理過程混亂**: 不同IP的處理過程相互干擾
4. **全局停止**: 一個IP的操作影響所有其他IP

## 調試信息

### 服務器日誌

觀察服務器控制台的輸出：

```
收到查詢請求: IP=192.168.1.100, 問題='EMX-BTX-D', 時間區間='20200101-20201231'
收到查詢請求: IP=192.168.1.101, 問題='EMX-BTX-D', 時間區間='20200101-20201231'
已清理IP 192.168.1.100 的所有任務
```

### 任務管理狀態

可以在代碼中添加調試信息來查看任務管理狀態：

```python
# 在 app.py 中添加
def debug_task_status():
    with task_lock:
        print("當前任務狀態:")
        for ip, tasks in running_tasks_by_ip.items():
            print(f"  IP {ip}: {len(tasks)} 個任務")
            for task_id, task_data in tasks.items():
                print(f"    - {task_id}: {task_data.get('start_time', 'unknown')}")
```

## 常見問題排查

### 問題1: IP識別不正確

**症狀**: 不同IP被識別為相同IP

**解決方案**:
- 檢查代理設置
- 確認 `X-Forwarded-For` header 正確設置
- 使用 `get_client_ip()` 函數調試

### 問題2: 任務仍然被中斷

**症狀**: 一個IP的操作影響其他IP

**解決方案**:
- 檢查 `cleanup_ip_tasks()` 函數是否正確實現
- 確認每個IP的任務獨立管理
- 檢查lock機制是否正確使用

### 問題3: 內存使用過高

**症狀**: 服務器內存使用持續增長

**解決方案**:
- 檢查任務清理機制
- 確認過期任務自動清理
- 監控 `running_tasks_by_ip` 的大小

## 性能測試

### 並發用戶測試

```bash
# 使用 Apache Bench 測試
ab -n 100 -c 10 http://localhost:5000/

# 使用 wrk 測試
wrk -t12 -c400 -d30s http://localhost:5000/
```

### 內存使用監控

```bash
# 監控Python進程內存使用
watch -n 1 'ps aux | grep python | grep app.py'
```

## 驗證清單

- [ ] 單個用戶功能正常
- [ ] 多個IP可以同時使用
- [ ] 每個IP的任務獨立
- [ ] 頁面刷新只影響當前IP
- [ ] 任務完成後正確清理
- [ ] 過期任務自動清理
- [ ] 篩選交互查詢正常
- [ ] 文檔內容查詢正常
- [ ] 錯誤處理正確
- [ ] 內存使用穩定

## 報告問題

如果發現問題，請提供以下信息：

1. **錯誤描述**: 詳細描述問題現象
2. **重現步驟**: 如何重現問題
3. **預期行為**: 應該發生什麼
4. **實際行為**: 實際發生了什麼
5. **環境信息**: 操作系統、Python版本、依賴版本
6. **日誌信息**: 服務器控制台輸出
7. **測試結果**: 測試腳本的輸出結果 